#!/usr/bin/env python3

from datetime import datetime
import json
import os
import re
import subprocess
import sys


AIRPORT_PATH = '/System/Library/PrivateFrameworks/Apple80211.framework/Versions/Current/Resources/airport'


def do_backup(repo_info, conf):
    repo = repo_info['repo']
    passphrase = repo_info.get('passphrase')
    prefix = conf['prefix']
    prefix_glob = conf['prefix-glob']
    keep = conf['keep']

    os.chdir(conf['root'])

    timestamp = datetime.now().astimezone().strftime('%FT%T%z')
    borg_cmd(
        'create',
        '--progress',
        '--stats',
        f'{repo}::{prefix}{timestamp}',
        '.',
        passphrase=passphrase
    )

    borg_cmd(
        'prune',
        repo,
        '--glob-archives',
        prefix_glob,
        '--stats',
        f'--keep-within={keep["within"]}',
        f'--keep-daily={keep["daily"]}',
        f'--keep-weekly={keep["weekly"]}',
        f'--keep-monthly={keep["monthly"]}',
        f'--keep-yearly={keep["yearly"]}',
        passphrase=passphrase
    )


def get_ssid():
    out = subprocess.check_output([AIRPORT_PATH, '-I'])
    for line in out.decode('utf8').split('\n'):
        m = re.match(r'\s+SSID: (.*)', line)
        if m:
            ssid = m.group(1)
            if ssid == '':
                return None
            return ssid
    return None


def borg_cmd(*cmd, passphrase=None):
    cmd = ('borg',) + cmd
    if passphrase is not None:
        read_fd, write_fd = os.pipe()
        env = dict(os.environ)
        env['BORG_PASSPHRASE_FD'] = str(read_fd)
        # POSIX requires pipe buffer to be at least 512 bytes, so it's fine to do a
        # blocking write here before there is anyone reading
        os.write(write_fd, passphrase.encode('utf8'))
        os.close(write_fd)  # EOF
        subprocess.check_call(cmd, pass_fds=(sys.stdout.fileno(), sys.stderr.fileno(), read_fd), env=env)
        os.close(read_fd)
    else:
        subprocess.check_call(cmd, pass_fds=(sys.stdout.fileno(), sys.stderr.fileno()))


def main():
    if len(sys.argv) not in [2, 3]:
        print(f'usage: {sys.argv[0]} config_file [override_ssid]', file=sys.stderr)
        exit(1)
    with open(sys.argv[1]) as f:
        conf = json.load(f)
    if len(sys.argv) == 3:
        ssid = sys.argv[2]
    else:
        ssid = get_ssid()
    if ssid is None:
        print(f'Not connected to a WiFi network.')
    if ssid not in conf['repos']:
        print(f'No backup configuration for SSID "{ssid}".')
        exit(1)
    repo_info = conf['repos'][ssid]
    print(f'Backing up to {repo_info["repo"]}')
    del conf['repos']
    do_backup(repo_info, conf)


if __name__ == '__main__':
    main()
